<div class="mb-2">

  <!-- Location card header - always visible -->
  <div class="p-2 pb-0 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors cursor-pointer">

    <!-- Show a message if it's a dummy packet -->
    <div *ngIf="isDummy" class="p-2 mb-2 bg-yellow-100 text-yellow-800 rounded">
      <i class="pi pi-info-circle mr-2"></i> You are creating a new packet. Fill in the details and save.
    </div>

    <div class="flex justify-between items-start">

      <span>
        <span class="flex"><i class="pi pi-box" ></i><ni-id-print *ngIf="!isDummy" [id]="localPacket.id"></ni-id-print></span>
        <span *ngIf="isDummy" class="font-light text-blue-400"> New packet </span>
      </span>

      <div *ngIf="!isEditMode">
        <i class="pi pi-cog text-blue-500 cursor-pointer hover:text-blue-700" (click)="openPacketDialog()"></i>
        <i class="pi pi-pencil text-blue-500 cursor-pointer hover:text-blue-700" (click)="openPacketEdit()"></i>
      </div>
      <div *ngIf="isEditMode">
        <i class="pi pi-trash text-red-500 cursor-pointer hover:text-red-700" (click)="onDeleteClick($event)"></i>
        <button class="text-blue-500 hover:text-blue-700" (click)="onSaveClick($event)"><i class="pi pi-check"></i></button>
        <button class="text-red-500 hover:text-red-700 ml-2" (click)="onCancelClick($event)"><i class="pi pi-times"></i> </button>
      </div>
    </div>
    <div *ngIf="!isDummy"  class="flex justify-between items-center mt-2">
      <p-tag>
        <i class="pi pi-box text-blue-500"></i>
        <span>{{ packet?.count || "--" }}</span>
        Pcs
      </p-tag>
      <p-tag>
        <i class="pi pi-dollar text-blue-500"></i>
        <span>{{ (packet?.count * packet?.itemValue | currency:'CZK':'symbol':'1.2-2') || "--" }}</span>
      </p-tag>
      <p-tag>
        <i class="pi pi-box text-blue-500"></i>
        <span>{{ (packet?.itemValue | currency:'CZK':'symbol':'1.2-2' )|| "--"}}</span>
      </p-tag>
    </div>

    <div class="text-sm text-gray-600 mt-2">
      <div class="flex items-st gap-1 mb-1">
        <i class="pi pi-map-marker text-blue-500"></i>
        <span *ngIf="!isEditMode">
          <span *ngIf="packet?.location">{{ packet?.location?.full_path }} <span>( {{packet?.location?.description}} )</span></span>
          <span *ngIf="!packet?.location"> Location is not set</span>
        </span>
        <ni-select-location *ngIf="isEditMode" [(ngModel)]="localPacket.location.id" class="flex-grow"></ni-select-location>
      </div>

      <div class="flex items-center gap-1 mb-1">
        <i class="pi pi-link text-blue-500"></i>
        <span *ngIf="!isEditMode && packet?.supplier">
          <a [href]="packet?.supplier?.url" target="_blank" class="text-blue-500 hover:text-blue-700">
            {{ packet?.supplier?.name }}
          </a>
        </span>
        <input *ngIf="isEditMode" [(ngModel)]="localPacket.reference" class="border flex-grow" />
      </div>

      <div *ngIf="!isEditMode" class="flex items-center gap-1 mb-1">
        <i class="pi pi-calendar text-blue-500"></i>
        <span>{{ packet?.created_at | date:'dd.MM.yyyy' }}</span>
      </div>

    </div>

    <div class="flex items-center text-sm">
      <i class="pi pi-comment text-blue-500"></i>
      <div *ngIf="!isEditMode" class="text-gray-700 p-2 py-0 bg-gray-50 rounded flex-grow">
        {{ packet?.description }}
      </div>
      <textarea *ngIf="isEditMode" [(ngModel)]="localPacket.description" class="flex-grow w-full border"></textarea>
    </div>

    <!-- Toggle indicator -->
    <div *ngIf="!isEditMode && !isDummy" class="flex justify-center mt-2" (click)="toggleOperations()">
      <span class="text-xs text-blue-600 flex items-center">
        <i [class]="expandedOperations ? 'pi pi-chevron-up' : 'pi pi-chevron-down'" class="mr-1"></i>
        {{ expandedOperations ? 'Hide operations' : 'Show operations' }}
      </span>
    </div>


<!-- =========================================== -->

  <!-- Expandable operations section -->
  <div *ngIf="expandedOperations && !isDummy"
       class="transition-all">

    <div class="flex justify-end mb-2">
      <ni-print-button type="packet" [id]="packet?.id"></ni-print-button>
      <i class="pi pi-plus text-blue-500 cursor-pointer hover:text-blue-700" (click)="openCreateOperationDialog()" pTooltip="Add Operation"></i>
      <i class="pi pi-refresh text-blue-500 cursor-pointer hover:text-blue-700 ml-3" (click)="recalculateStock()" pTooltip="Recalculate Stock"></i>
    </div>

    <!-- Loading indicator -->
    <div *ngIf="loadingOperations" class="p-3 flex justify-center">
      <p-progressSpinner styleClass="w-8 h-8" strokeWidth="4"></p-progressSpinner>
    </div>

    <!-- No operations message -->
    <div *ngIf="!loadingOperations && operations.length === 0" class="p-4 text-center text-gray-500">
      <i class="pi pi-info-circle text-3xl mb-2 block"></i>
      <p>No operations found for this packet</p>
    </div>

    <!-- Operations table -->
    <div *ngIf="!loadingOperations && operations.length > 0" class="mt-2 small" size="small">
      <p-table [value]="operations"
           styleClass="p-datatable-sm"
           size="small"
           [tableStyle]="{'min-width': '100%'}"
           [paginator]="true"
           [rows]="10"
           [rowHover]="true">
        <ng-template pTemplate="header">
          <tr>
        <th>Type</th>
        <th>Amount</th>
        <th>Date</th>
        <th>Note</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-operation>
          <tr>
        <td>
          <span pTooltip="{{ operation?.operation_type || 'N/A' }}" class="px-2 py-1 rounded-full text-xs font-medium">
              <i class="pi" [ngClass]="{
                            'pi-file-check': operation?.operation_type == 'inventory',
                            'pi-shopping-cart': operation?.operation_type == 'buy',
                            'pi-wrench': operation?.operation_type == 'service',
                            'pi-arrow-up': operation?.operation_type == 'OUT',
                          }
                          "></i>
          </span>
        </td>
        <td><span pTooltip="{{operation | json}}">{{ operation?.quantity }}</span></td>
        <td>
          <span class="text-gray-600" pTooltip="{{operation?.created_at | date:'dd.MM.yyyy, HH:mm:ss'}}" tooltipPosition="top">
            {{ operation?.created_at | date:'dd.MM.yy' }}
          </span>
        </td>
        <td><span pTooltip="{{operation?.description}}" >{{ (operation?.description || '') | slice:0:20 }}</span></td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  </div>
</div>
