<div class="component-container p-4">
  <p-toast></p-toast>
  <p-progressSpinner *ngIf="loading" styleClass="w-8 h-8" strokeWidth="4"></p-progressSpinner>
  <p-message *ngIf="error" severity="error" [text]="error" styleClass="w-full"></p-message>

  <div *ngIf="componentData && !loading && !error" class="component-data">
    <!-- Main grid layout for page -->
    <div [ngClass]="{'grid grid-cols-1 gap-0': isMobile, 'grid grid-cols-12': !isMobile}">
      <!-- Main content column (2/3 width) -->
      <div class="col-span-8">
          <!-- Main component card -->
        <p-card class="mb-4">
          <ng-template pTemplate="header">
            <div class="flex flex-row justify-between items-center p-4 bg-gradient-to-r from-blue-50 to-blue-100" style="border-radius: 6px 6px 0 0; margin: -1px -1px 0 -1px;">
              <div class="flex-1">
                <h1 *ngIf="!editMode" class="text-3xl font-bold text-gray-800 m-0">{{ componentData.name }}</h1>
                <div *ngIf="editMode">
                  <label i18n for="name" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                  <input pInputText id="name" [(ngModel)]="editedComponent.name" class="w-full" />
                </div>
              </div>
              <div class="flex gap-3">
                <button *ngIf="!editMode" pButton icon="pi pi-pencil" (click)="toggleEditMode()" class="p-button-rounded p-button-warning" pTooltip="Edit"></button>
                <button *ngIf="editMode" pButton icon="pi pi-times" (click)="cancelEdit()" class="p-button-rounded p-button-secondary" pTooltip="Cancel"></button>
                <button *ngIf="editMode" pButton icon="pi pi-check" (click)="saveChanges()" class="p-button-rounded p-button-success" pTooltip="Save"></button>
              </div>
            </div>
          </ng-template>

          <ng-template pTemplate="content">

          <!-- Nested layout for main content -->

            <div [ngClass]="{'grid grid-cols-1': isMobile, 'grid grid-cols-12': !isMobile}">

            <!-- Left side: Title, ID, Image -->
            <div class="col-span-4">
              <div class="flex items-center gap-2 mb-3">
                <span i18n="@@componentIdLabel" class="text-sm text-gray-500">ID:</span>
                <ni-id-print [id]="componentData.id" class="text-sm text-grapy-500"></ni-id-print>
              </div>

              <!-- Image with fixed size -->
              <div class="mb-4">
                <div class="flex justify-center">
                  <p-image
                  *ngIf="componentData.primary_image && !editMode"
                  [src]="componentData.primary_image"
                  [alt]="componentData.name"
                  [style]="{'width': '100%', 'max-height': '300px'}"
                  imageClass="object-contain"
                  [preview]="true"
                  ></p-image>
                </div>

                <div *ngIf="!componentData.primary_image && !editMode"
                     class="bg-gray-200 flex items-center justify-center rounded"
                     style="max-width: 250px; max-height: 200px;">
                  <i class="pi pi-image text-4xl text-gray-400"></i>
                </div>

                <!-- Image URL edit field -->
                <div *ngIf="editMode" class="mb-3">
                  <label i18n for="imageUrl" class="block text-sm font-medium text-gray-700 mb-1">Image URL</label>
                  <input pInputText id="imageUrl" [(ngModel)]="editedComponent.primary_image" class="w-full" placeholder="Zadejte URL obrázku" />

                  <!-- Preview of current image during edit -->
                  <div *ngIf="editedComponent.primary_image" class="mt-2">
                    <p-image
                      [src]="editedComponent.primary_image"
                      [alt]="editedComponent.name"
                      [style]="{'width': '250px', 'height': '200px'}"
                      imageClass="object-contain"
                      [preview]="true"
                    ></p-image>
                  </div>
                </div>
              </div>
            </div>

            <!-- Right side: Component information and description -->
            <div class="col-span-8">
              <!-- Product information section -->
              <div class="mb-4">
                <!-- Category and Tags -->
                <div class="mb-3">
                  <div *ngIf="!editMode && componentData.category" class="mb-2">
                    <p-tag
                      [value]="componentData.category.name"
                      [style]="{'background-color': componentData.category.color || 'rgb(208 226 255)'}"
                      severity="info"
                    ></p-tag>
                  </div>

                  <div *ngIf="editMode" class="mb-3">
                    <label i18n for="category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                    <ni-select-category
                      id="category"
                      [(ngModel)]="editedComponent.category"
                      styleClass="w-full"
                    ></ni-select-category>
                  </div>

                  <div *ngIf="!editMode && componentData.tags?.length" class="flex flex-wrap gap-1">
                    <p-chip *ngFor="let tag of componentData.tags" [label]="tag.name" styleClass="text-xs"></p-chip>
                  </div>

                  <div *ngIf="editMode" class="mb-3">
                    <label i18n class="block text-sm font-medium text-gray-700 mb-1">Tags</label>
                    <ni-select-tags
                      id="tags"
                      [(ngModel)]="editedComponent.tags"
                      styleClass="w-full"
                    ></ni-select-tags>
                  </div>
                </div>

                <div class="flex flex-col gap-2">
                  <div class="flex justify-between p-2 bg-gray-50 rounded">
                    <span class="font-semibold">Jednotka:</span>
                    <span>{{ componentData.unit_type }}</span>
                  </div>

                  <div *ngIf="!editMode" class="flex justify-between p-2 bg-gray-50 rounded">
                    <span class="font-semibold">Interní cena:</span>
                    <span class="font-semibold text-blue-600">{{ componentData.internal_price | currency:'CZK':'symbol':'1.2-2' }}</span>
                  </div>

                  <div *ngIf="editMode" class="p-2 bg-gray-50 rounded">
                    <div class="flex justify-between items-center">
                      <label for="internalPrice" class="font-semibold">Interní cena:</label>
                      <p-inputNumber id="internalPrice"
                                     [(ngModel)]="editedComponent.internal_price"
                                     mode="currency"
                                     currency="CZK"
                                     locale="cs-CZ"
                                     [minFractionDigits]="2">
                      </p-inputNumber>
                    </div>
                  </div>

                  <div *ngIf="!editMode && componentData.selling_price" class="flex justify-between p-2 bg-gray-50 rounded">
                    <span class="font-semibold">Prodejní cena:</span>
                    <span class="font-semibold text-green-600">{{ componentData.selling_price | currency:'CZK':'symbol':'1.2-2' }}</span>
                  </div>

                  <div *ngIf="editMode" class="p-2 bg-gray-50 rounded">
                    <div class="flex justify-between items-center">
                      <label for="sellingPrice" class="font-semibold">Prodejní cena:</label>
                      <p-inputNumber id="sellingPrice"
                                     [(ngModel)]="editedComponent.selling_price"
                                     mode="currency"
                                     currency="CZK"
                                     locale="cs-CZ"
                                     [minFractionDigits]="2">
                      </p-inputNumber>
                    </div>
                  </div>

                  <div class="flex justify-between p-2 bg-gray-50 rounded">
                    <span class="font-semibold">Vytvořeno:</span>
                    <span>{{ componentData.created_at | date:'dd.MM.yyyy' }}</span>
                  </div>

                  <!-- Stock information -->
                  <div *ngIf="componentData.packets?.length" class="mt-2 p-3 bg-blue-50 rounded">
                    <div class="flex justify-between">
                      <span class="font-semibold">Počet lokací:</span>
                      <span class="font-semibold">{{ componentData.packets.length }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Description placed below the information -->
          <div class="p-3 bg-gray-50 border border-gray-200 rounded-md shadow-sm">
            <h3 class="text-sm font-semibold text-gray-600 mb-1">Popis</h3>
            <p *ngIf="!editMode" class="text-gray-700">{{ componentData.description }}</p>
            <div *ngIf="editMode">
              <textarea pInputTextarea [(ngModel)]="editedComponent.description" rows="5" class="w-full"></textarea>
            </div>
          </div>
          </ng-template>
        </p-card>

        <!-- Tabs with detailed information -->
        <div>
          <p-tabs>
            <!-- Suppliers Tab -->
            <p-tabpanel header="Suppliers" *ngIf="componentData.suppliers?.length">
              <div class="py-3">
                <ni-suppliers-list [componentId]="componentData.id"></ni-suppliers-list>
              </div>
            </p-tabpanel>

            <!-- Other tabs remain unchanged -->
            <p-tabpanel header="Umístění" *ngIf="componentData.packets?.length">
              <div class="py-3">
                <div class="p-4 bg-white rounded-lg shadow">
                  <h3 class="text-lg font-semibold text-gray-800 mb-4">Skladové pozice</h3>
                <p-table [value]="componentData.packets" styleClass="p-datatable-sm p-datatable-striped" [tableStyle]="{'min-width': '50rem'}">
                  <ng-template pTemplate="header">
                    <tr>
                      <th style="width: 20%">ID</th>
                      <th style="width: 35%">Umístění</th>
                      <th style="width: 15%">Vytvořeno</th>
                      <th style="width: 30%">Popis</th>
                    </tr>
                  </ng-template>
                  <ng-template pTemplate="body" let-packet>
                    <tr class="cursor-pointer hover:bg-gray-50" [routerLink]="['/store/packet', packet.id]">
                      <td class="text-xs">
                        <div class="flex items-center gap-2">
                          <span>{{ packet.id }}</span>
                          <app-copy-button [text]="packet.id" tooltip="Zkopírovat ID"></app-copy-button>
                        </div>
                      </td>
                      <td>
                        <a [routerLink]="['/store/location', packet.location.id]" 
                           (click)="$event.stopPropagation()" 
                           class="font-semibold text-blue-600 hover:underline">
                          {{ packet.location.full_path }}
                        </a>
                      </td>
                      <td>{{ packet.created_at | date:'dd.MM.yyyy' }}</td>
                      <td>{{ packet.description }}</td>
                    </tr>
                  </ng-template>
                </p-table>
              </div>
              </div>
            </p-tabpanel>

            <p-tabpanel header="Parameters">
              <div class="py-3">
                <ni-parameters-list [componentId]="componentData.id"></ni-parameters-list>
              </div>
            </p-tabpanel>
          </p-tabs>
        </div>
      </div>

      <!-- Right column with expandable location cards -->
      <div class="col-span-4">
        <!-- Quick Actions -->
        <p-card class="mb-4">
          <ng-template pTemplate="header">
            <div class="flex justify-between items-center p-3 bg-blue-50">
              <h3 class="text-lg font-semibold text-blue-800 m-0">Rychlé akce</h3>
            </div>
          </ng-template>
          <ng-template pTemplate="body">
            <div class="grid grid-cols-2 gap-2">
              <button pButton label="Dokoupit" icon="pi pi-shopping-cart" class="p-button-sm" (click)="requestBuy()"></button>
              <button pButton label="Nový packet" icon="pi pi-plus" class="p-button-sm p-button-success" (click)="quickNewPacket()"></button>
              <ni-print-button [type]="'component'" [id]="componentData.id"></ni-print-button>
              <button pButton label="Inventura" icon="pi pi-file-check" class="p-button-sm p-button-secondary" (click)="messageService.add({severity:'info', summary:'Inventura', detail:'Dummy akce'})"></button>
            </div>
          </ng-template>
        </p-card>

        <p-card class="block">
          <ng-template pTemplate="header">
            <div class="flex justify-between items-center p-3 bg-blue-50">
              <h3 class="text-lg font-semibold text-blue-800 m-0">Warehouse locations</h3>
              <div>
                <span *ngIf="componentData.packets?.length" class="bg-blue-100 text-blue-800 py-1 px-2 rounded-full text-sm font-semibold">
                  {{ componentData.packets.length }}
                </span>
                <i class="pi pi-plus text-blue-800 cursor-pointer" (click)="createNewPacket()"></i>
              </div>
            </div>
          </ng-template>

          <!-- TODO: This should be placed in own component, that will be able to refresh only packets.. -->
          <ng-template pTemplate="body" style="padding: 0pt !important ;" class="p-0">
              <div *ngIf="componentData.packets?.length" class="p-m-0 p-mb-0 p-0">
                <!-- Dummy packet card for creating new packet -->
                <ni-packet-card *ngIf="creatingPacket" [isDummy]="true" [componentId]="componentData.id" ></ni-packet-card>

                <div *ngFor="let packet of componentData.packets" class="p-mb-0">
                  <!-- Location card header - always visible -->
                  <ni-packet-card [packet]="packet"></ni-packet-card>
                </div>
              </div>
          </ng-template>
        </p-card>
      </div>
    </div>
  </div>
</div>

