<div class="p-4">
  <p-toast></p-toast>
  <p-progressSpinner *ngIf="loading"></p-progressSpinner>

  <div *ngIf="!loading && location">
    <!-- Header with back button and edit controls -->
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-3">
        <button pButton icon="pi pi-arrow-left" [routerLink]="['/store/locations']" class="p-button-text"></button>
        <h1 class="text-3xl font-bold">{{ location.name }}</h1>
      </div>
      <div class="flex gap-2">
        <button *ngIf="!editMode" pButton icon="pi pi-pencil" label="Edit" (click)="toggleEditMode()" class="p-button-warning"></button>
        <button *ngIf="editMode" pButton icon="pi pi-times" label="Cancel" (click)="cancelEdit()" class="p-button-secondary"></button>
        <button *ngIf="editMode" pButton icon="pi pi-check" label="Save" (click)="saveChanges()" class="p-button-success"></button>
      </div>
    </div>

    <!-- Two column layout for desktop -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
      <!-- Main info card -->
      <p-card>
        <ng-template pTemplate="header">
          <div class="p-3 bg-blue-50 flex justify-between items-center">
            <h2 class="text-xl font-semibold m-0">Location Details</h2>
            <div class="flex gap-2">
              <p-tag *ngIf="location.can_store_items" value="Physical Location" severity="success" icon="pi pi-box"></p-tag>
              <p-tag *ngIf="!location.can_store_items" value="Logical Location" severity="info" icon="pi pi-folder"></p-tag>
            </div>
          </div>
        </ng-template>

      <div class="flex flex-col gap-3">
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
          <span class="font-semibold text-gray-600">Name:</span>
          <span *ngIf="!editMode" class="text-gray-900">{{ location.name }}</span>
          <input *ngIf="editMode" pInputText [(ngModel)]="editedLocation.name" class="flex-1 ml-4" />
        </div>
        
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
          <span class="font-semibold text-gray-600">Full Path:</span>
          <span class="text-gray-900">{{ location.full_path }}</span>
        </div>
        
        <div class="flex flex-col p-3 bg-gray-50 rounded">
          <span class="font-semibold text-gray-600 mb-2">Description:</span>
          <span *ngIf="!editMode" class="text-gray-900">{{ location.description || 'No description' }}</span>
          <textarea *ngIf="editMode" pInputText [(ngModel)]="editedLocation.description" rows="3" class="w-full"></textarea>
        </div>
        
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
          <span class="font-semibold text-gray-600">Can Store Items:</span>
          <span *ngIf="!editMode" class="text-gray-900">{{ location.can_store_items ? 'Yes' : 'No' }}</span>
          <p-checkbox *ngIf="editMode" [(ngModel)]="editedLocation.can_store_items" [binary]="true"></p-checkbox>
        </div>
        
        <div *ngIf="location.parent" class="flex justify-between items-center p-3 bg-gray-50 rounded">
          <span class="font-semibold text-gray-600">Parent Location:</span>
          <a [routerLink]="['/store/location', location.parent]" class="text-blue-600 hover:underline flex items-center gap-1">
            <i class="pi pi-arrow-up"></i>
            View Parent
          </a>
        </div>
      </div>
      </p-card>

      <!-- Sub-locations tree -->
      <p-card>
      <ng-template pTemplate="header">
        <div class="p-3 bg-blue-50">
          <h2 class="text-xl font-semibold m-0">Sub-locations</h2>
        </div>
      </ng-template>
      <p-tree [value]="childrenTree" *ngIf="childrenTree.length > 0">
        <ng-template let-node pTemplate="default">
          <a [routerLink]="['/store/location', node.data.id]" class="flex items-center gap-2">
            <i [class]="node.data?.can_store_items ? 'pi pi-box text-blue-600' : 'pi pi-folder text-gray-500'"></i>
            <span>{{ node.label }}</span>
          </a>
        </ng-template>
      </p-tree>
      <div *ngIf="childrenTree.length === 0" class="text-center p-4 text-gray-500">
        No sub-locations
      </div>
      </p-card>
    </div>

    <!-- Components in this location -->
    <p-card>
      <ng-template pTemplate="header">
        <div class="p-3 bg-blue-50">
          <h2 class="text-xl font-semibold m-0">Components in this Location</h2>
        </div>
      </ng-template>
      
      <div *ngIf="!location.can_store_items" class="text-center p-4 text-gray-500">
        <i class="pi pi-folder text-4xl mb-3"></i>
        <p>This is a logical location and cannot store components.</p>
      </div>
      
      <div *ngIf="location.can_store_items">
        <p-table [value]="packets" *ngIf="packets.length > 0">
          <ng-template pTemplate="header">
            <tr>
              <th style="width: 20%">ID</th>
              <th style="width: 30%">Component</th>
              <th style="width: 15%">Quantity</th>
              <th style="width: 35%">Description</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-packet>
            <tr [routerLink]="['/store/packet', packet.id]" class="cursor-pointer hover:bg-gray-50">
              <td>
                <div class="flex items-center gap-2">
                  <app-copy-button [text]="packet.id" tooltip="ZkopÃ­rovat ID"></app-copy-button>
                  <span class="text-xs text-gray-500 truncate">{{ packet.id }}</span>
                </div>
              </td>
              <td>
                <a [routerLink]="['/store/component', packet.component?.id]" 
                   (click)="$event.stopPropagation()" 
                   class="text-blue-600 hover:underline">
                  {{ packet.component?.name }}
                </a>
              </td>
              <td>{{ packet.quantity }}</td>
              <td>{{ packet.description }}</td>
            </tr>
          </ng-template>
        </p-table>
        
        <div *ngIf="packets.length === 0" class="text-center p-4 text-gray-500">
          No components in this location
        </div>
      </div>
    </p-card>
  </div>

  <div *ngIf="!loading && !location" class="text-center p-4">
    <p class="text-gray-500">Location not found</p>
    <button pButton label="Back to Locations" [routerLink]="['/store/locations']" class="mt-3"></button>
  </div>
</div>
