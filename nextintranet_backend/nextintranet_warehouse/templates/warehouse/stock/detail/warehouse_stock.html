{% load static %}
{% load i18n %}
{% load format_uuid %}


<div class="card mb-4">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="card-title text-muted">
        Warehouse packets <span class="text-secondary">({{ item.packets.count }})</span>
      </h4>
      <a href="./new_packet/" class="d-flex align-items-center text-secondary text-decoration-none">
        <span class="material-icons me-1">add</span>
        Add Packet
      </a>
    </div>

    <!-- Aktuální sklad -->
    <div>
      <h5 class="h6 text-secondary mb-3">Current Warehouse</h5>

      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>ID</th>
              <th>Location</th>
              <th>Description</th>
              <th>Stock</th>
              <th>Item Price</th>
              <th>Total Price</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for bag in item.packets.all %}
            <tr>
              <td>{{ bag.id | format_uuid }}</td>
              <td>{{ bag.location }}</td>
              <td>{{ bag.description }}</td>
              <td>{{ bag.count }}</td>
              <td>${{ bag.itemValue }}</td>
              <td>${{ bag.totalValue }}</td>
              <td>
                <a href="/store/packet/{{ bag.id }}/edit" class="text-secondary text-decoration-none">
                  <span class="material-icons">edit</span>
                </a>
                <a href="/store/packet/{{ bag.id }}/operation/" class="text-secondary text-decoration-none">
                  <span class="material-icons">build</span>
                </a>
                <button class="btn btn-link text-secondary p-0" onclick="printLabel('store/print/packet/', '{{ bag.id }}')">
                  <span class="material-icons">print</span>
                </button>
                <button class="btn btn-link text-secondary p-0" onclick="copyToClipboard('{{ bag.get_absolute_url }}')">
                  <span class="material-icons">content_copy</span>
                </button>
                <button class="btn btn-link text-secondary p-0" data-bs-toggle="collapse" data-bs-target="#collapse{{ bag.id }}" aria-expanded="false">
                  <span class="material-icons">expand_more</span>
                </button>
              </td>
            </tr>
            <tr id="collapse{{ bag.id }}" class="collapse">
              <td colspan="7">
                <div class="row">
                  <div class="col-md-5">
                    <div class="p-3 bg-light h-100">
                      <h6 class="fw-semibold text-secondary">Details</h6>
                      <div class="mb-1"><strong>Location:</strong> {{ bag.location }}</div>
                      <div class="mb-1"><strong>Description:</strong> {{ bag.description }}</div>
                      <div class="mb-1"><strong>Date Added:</strong> {{ bag.date_added }}</div>
                      <div class="mb-1"><strong>Last Update:</strong> {{ bag.last_operation.timestamp }}</div>
                      <div class="mb-1"><strong>Stock:</strong> {{ bag.count }}</div>
                      <div class="mb-1"><strong>Item Price:</strong> ${{ bag.itemValue }}</div>
                      <div class="mb-1"><strong>Total Price:</strong> ${{ bag.totalValue }}</div>
                    </div>
                  </div>
                  <div class="col-md-7 pl-0">
                    <div class="h-100 overflow-y: auto;">
                        {% if bag.operations.all %}
                        <table class="table table-sm">
                          <thead>
                            <tr>
                              <th>Operation</th>
                              <th>Quantity</th>
                              <th>Price</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for entry in bag.operations.all|dictsort:"timestamp" reversed %}
                            <tr>
                                <td data-bs-toggle="tooltip" data-bs-placement="top" title="Date: {{ entry.timestamp|date:'Y-m-d H:i' }} | Author: {{ entry.author|default:'NotSet' }}">{{ forloop.counter }} <span class="badge bg-secondary rounded-pill">{{entry.operation_type}}</span> {{entry.timestamp}}</td>
                              <td>{{ entry.quantity }}</td>
                              <td>{{ entry.unit_price }}</td>
                            </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                        {% else %}
                        <p class="text-muted small mt-2">No history available.</p>
                        {% endif %}
                    </div>
                  </div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Ostatní sklady -->
    <div class="mt-4">
      <h5 class="h6 text-secondary mb-3">Other Warehouses</h5>
      <ul class="list-group">
        <li v-for="warehouse in otherWarehouses" :key="warehouse.id" class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <h6 class="fw-bold text-dark">{{ warehouse.name }}</h6>
            <p class="text-secondary small">Total Items: {{ warehouse.totalItems }}</p>
          </div>
          <button @click="switchWarehouse(warehouse.id)" class="btn btn-primary btn-sm">
            Switch
          </button>
        </li>
      </ul>
    </div>
  </div>
</div>

<script src="qrc:/qtwebchannel/qwebchannel.js"></script>
<script>
  var nia;
  new QWebChannel(qt.webChannelTransport, function (channel) {
    nia = channel.objects.nia;
  });

  function copyToClipboard(text) {
    console.log('copying', text);
    const el = document.createElement('textarea');
    el.value = text;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
  }

  function printLabel(url, id) {
    console.log('printing', url, id);
    nia.print_local(url, id);
  }
</script>
